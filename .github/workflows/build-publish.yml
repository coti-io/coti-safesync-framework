name: Build and Publish

on:
  release:
    types: [ created ]
  workflow_dispatch:

concurrency:
  group: release-build
  cancel-in-progress: false

jobs:

  release-build:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Validate tag format
        run: |
          set -e
          TAG_NAME="${{ github.ref_name }}"
          if ! [[ "$TAG_NAME" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+(-.*)?$ ]]; then
            echo "Error: Tag $TAG_NAME is not a valid semantic version"
            exit 1
          fi
          echo "Tag $TAG_NAME is valid"

      - name: Update pyproject.toml version
        run: |
          set -e
          TAG_NAME="${{ github.ref_name }}"
          # Remove 'v' prefix if present
          VERSION="${TAG_NAME#v}"
          # Update version in pyproject.toml
          sed -i 's/^version = ".*"/version = "'"$VERSION"'"/' pyproject.toml
          echo "Updated pyproject.toml version to $VERSION"

      - name: Verify version update
        run: |
          set -e
          TAG_NAME="${{ github.ref_name }}"
          VERSION="${TAG_NAME#v}"
          CURRENT_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          if [ "$CURRENT_VERSION" != "$VERSION" ]; then
            echo "Error: Version update failed. Expected $VERSION, got $CURRENT_VERSION"
            exit 1
          fi
          echo "Version verification passed: $CURRENT_VERSION"

      - name: Commit and push changes
        run: |
          set -e
          TAG_NAME="${{ github.ref_name }}"
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git remote set-url origin https://github.com/${{ github.repository }}.git
          git add pyproject.toml
          # Only commit if there are changes
          if ! git diff --staged --quiet; then
            git commit -m "Update version to $TAG_NAME"
            git push origin HEAD
            echo "Committed and pushed version update"
          else
            echo "No changes to commit"
          fi
          # Update tag and push
          git tag -f "$TAG_NAME"
          git push --force origin "$TAG_NAME"
          echo "Tag $TAG_NAME updated and pushed"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-build-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-build-

      - name: Install build dependencies
        run: |
          set -e
          pip install build wheel

      - name: Build release distributions
        run: |
          set -e
          python -m build
          echo "Build completed successfully"

      - name: Verify distributions
        run: |
          set -e
          if [ ! -d dist/ ]; then
            echo "Error: dist/ directory not found"
            exit 1
          fi
          if ! ls dist/*.tar.gz 1> /dev/null 2>&1; then
            echo "Error: Source distribution (.tar.gz) not found"
            ls -la dist/
            exit 1
          fi
          if ! ls dist/*.whl 1> /dev/null 2>&1; then
            echo "Error: Wheel distribution (.whl) not found"
            ls -la dist/
            exit 1
          fi
          echo "Distribution files verified:"
          ls -lh dist/

      - name: Test package installation
        run: |
          set -e
          echo "Testing package installation..."
          pip install dist/*.whl --dry-run || pip install dist/*.tar.gz --dry-run
          echo "Package installation test passed"

      - name: Upload distributions
        uses: actions/upload-artifact@v4
        with:
          name: release-dists
          path: dist/
          retention-days: 30

  pypi-publish:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    timeout-minutes: 15
    needs:
      - release-build
    permissions:
      id-token: write
    environment:
      name: python-release-env
      url: https://github.com/${{ github.repository }}

    steps:
      - name: Retrieve release distributions
        uses: actions/download-artifact@v4
        with:
          name: release-dists
          path: dist/

      - name: Publish release distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1